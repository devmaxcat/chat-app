<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
</head>

<body>
    <h1>WebSocket Chat</h1>
    <div id="chat">
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button id="sendButton">Send</button>
    </div>
    <style>
        .message {
            padding: 1em
        }
    </style>

    <script>
         const messagesDiv = document.getElementById('messages');
         let lastknownmessageid = null
        async function init() {
            const res = await fetch('http://localhost:443/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',


                },
                credentials: 'include',
                body: JSON.stringify({
                    "username": "test2",
                    "password": "123456"
                }),
            })
            for (const pair of res.headers.entries()) {
                console.log(`${pair[0]}: ${pair[1]}`);
            }


            setInterval(() => {


            }, 2000)
        }
        init()

        function createMessage(messageData) {
           
            const message = document.createElement('div');
            message.classList.add('message')
            message.textContent = messageData.text_content;
            return message

        }

        function appendMessageHistory(messages) {
            let ms = []
            messages.forEach(element => {
                messagesDiv.prepend(createMessage(element));
                lastknownmessageid = element._id
                console.log(lastknownmessageid)
            });
            return ms
        }

        const ws = new WebSocket('ws://localhost:443/gateway', ['jwtauth']);

        ws.onopen = async function () {
            console.log('Connected to the server');

            fetch('http://localhost:443/api/channel/get?' + new URLSearchParams({
                   // cursorid: lastknownmessageid,
                    //channelid: '669819f89601761de9c47648'
                }), 
                {
                    credentials: 'include'
                } 
            )
            .then((res) => res.json())
            .then((data) => {
                console.log(data)
            })
         
            fetch('http://localhost:443/api/message/history?' + new URLSearchParams({
                    cursorid: lastknownmessageid,
                    channelid: '669819f89601761de9c47648'
                }), 
                {
                    credentials: 'include'
                } 
            )
            .then((res) => res.json())
            .then((data) => {
                appendMessageHistory(data)
            })
               
            
            const message = JSON.stringify({ Type: 'RetrieveHistory', Data: { channel_id: '669382bf1fa2e3290ce6a2af', eldest_known_message_id: lastknownmessageid } })
            ws.send(message);
        };

        ws.onmessage = function (event) {

            event = JSON.parse(event.data)
            if (event.Type == 'MessageRecieved') {
                let M = createMessage(event.Data)
                messagesDiv.appendChild(M);

            }
            if (event.Type == 'History') {
                appendMessageHistory(event.Data)
                console.log(event)
            }

        };

        ws.onclose = function () {
            console.log('Disconnected from the server'); // reload application
        };

        document.getElementById('sendButton').onclick = function () {
            const input = document.getElementById('messageInput');
            const message = JSON.stringify({ Type: 'MessageSent', Data: { text_content: input.value } })
            ws.send(message);
            input.value = '';
        };
    </script>
</body>

</html>